---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectList from '../../components/ProjectList.astro';
import { projects } from './projects';

// Extract all unique tags from projects
const allTags = [...new Set(projects.flatMap(project => project.tags || []))].sort();
---

<BaseLayout title="Projects">
  <div class="container mx-auto px-4">
    <div class="space-y-6">
      <div class="glass-panel p-4">
        <div class="flex flex-col gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <h3 class="text-lg font-medium">Filter by tag</h3>
            <button
              id="clear-filter"
              class="tag-pill clear-pill items-center gap-1.5 justify-start ml-auto opacity-0 pointer-events-none"
              aria-hidden="true"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
              Clear filter
            </button>
          </div>
          <div class="flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <button
                class="tag-filter tag-pill break-words"
                data-tag={tag}
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </div>
      <div id="project-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <ProjectList projects={projects} />
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ projects }}>
  // Client-side filtering logic
  document.addEventListener('DOMContentLoaded', () => {
    const tagButtons = document.querySelectorAll('.tag-filter');
    const clearFilterButton = document.getElementById('clear-filter');
    const projectContainer = document.getElementById('project-container');
    let activeTags = [];

    // Ensure clear button is visually hidden on load without collapsing layout
    if (clearFilterButton) {
      clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
      clearFilterButton.setAttribute('aria-hidden', 'true');
    }
    
    // Use the server-side passed projects variable directly
    const allProjects = projects;
    
    // Helper function to render filtered projects
    function renderProjects(filtered) {
      if (!projectContainer) return;
      
      projectContainer.innerHTML = '';
      
      if (filtered.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'text-center py-8 text-zinc-500 col-span-full';
        noResults.textContent = 'No projects match this filter';
        projectContainer.appendChild(noResults);
        return;
      }
      
      filtered.forEach((project) => {
        const projectCard = createProjectCard(project);
        projectContainer.appendChild(projectCard);
      });
    }
    
    // Helper function to create a project card
    function createProjectCard(project) {
        const cardContainer = document.createElement('div');
        cardContainer.className = 'h-full';

        const card = document.createElement('div');
        card.className = 'group flex flex-col h-full overflow-hidden rounded-xl glass-panel hover:scale-[1.015] transition-all duration-300';

        const imageContainer = document.createElement('div');
        imageContainer.className = 'aspect-video w-full overflow-hidden bg-zinc-100 dark:bg-zinc-800 relative';
        if (project.coverImage) {
            const img = document.createElement('img');
            img.src = project.coverImage;
            img.alt = project.name;
            img.className = 'h-full w-full object-cover object-center transition-transform duration-300 group-hover:scale-105';
            img.width = 720;
            img.height = 360;
            imageContainer.appendChild(img);
        } else {
            const noImage = document.createElement('div');
            noImage.className = 'flex h-full items-center justify-center text-zinc-400 dark:text-zinc-600';
            noImage.innerHTML = `<span class="text-sm">No Image</span>`;
            imageContainer.appendChild(noImage);
        }

        const content = document.createElement('div');
        content.className = 'flex flex-1 flex-col p-5';

        const title = document.createElement('h3');
        title.className = 'mb-2 text-xl font-bold leading-tight text-zinc-900 dark:text-zinc-100 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors';
        const titleLink = document.createElement('a');
        titleLink.href = project.demoLink;
        titleLink.target = '_blank';
        titleLink.rel = project.demoLinkRel;
        titleLink.textContent = project.name;
        title.appendChild(titleLink);

        const descriptionContainer = document.createElement('div');
        descriptionContainer.className = 'relative abstract-container';
        
        const description = document.createElement('p');
        description.className = 'mb-4 flex-1 text-sm leading-relaxed text-zinc-600 dark:text-zinc-400 line-clamp-3 abstract-truncated';
        description.textContent = project.description;

        const fullDescription = document.createElement('div');
        fullDescription.className = 'absolute bottom-full left-0 mb-2 p-2 bg-gray-100 dark:bg-zinc-800 rounded text-xs w-full max-h-64 z-20 overflow-y-auto abstract-full';
        fullDescription.textContent = project.description;
        fullDescription.style.display = 'none';

        descriptionContainer.appendChild(description);
        descriptionContainer.appendChild(fullDescription);

        const footer = document.createElement('div');
        footer.className = 'flex justify-end gap-3 mt-auto self-end';

        if (project.postLink) {
            const postLink = document.createElement('a');
            postLink.className = 'tag-pill flex items-center gap-1';
            postLink.href = project.postLink;
            postLink.textContent = 'Article';
            footer.appendChild(postLink);
        }

        if (project.paperLink) {
            const paperLink = document.createElement('a');
            paperLink.className = 'tag-pill flex items-center gap-1';
            paperLink.href = project.paperLink;
            paperLink.target = '_blank';
            paperLink.rel = 'noopener';
            paperLink.textContent = 'Paper';
            footer.appendChild(paperLink);
        }

        if (project.demoLink) {
            const demoLink = document.createElement('a');
            demoLink.className = 'tag-pill flex items-center gap-1';
            demoLink.href = project.demoLink;
            demoLink.target = '_blank';
            demoLink.rel = project.demoLinkRel;
            demoLink.textContent = 'Demo';
            footer.appendChild(demoLink);
        }

        content.appendChild(title);
        content.appendChild(descriptionContainer);
        content.appendChild(footer);
        card.appendChild(imageContainer);
        card.appendChild(content);
        cardContainer.appendChild(card);

        let hideTimeout;

        const showFullAbstract = () => {
            clearTimeout(hideTimeout);
            fullDescription.style.display = 'block';
            const fullRect = fullDescription.getBoundingClientRect();
            if (fullRect.right > window.innerWidth) {
                fullDescription.style.right = '0';
                fullDescription.style.left = 'auto';
            }
            if (fullRect.left < 0) {
                fullDescription.style.left = '0';
                fullDescription.style.right = 'auto';
            }
        };

        const hideFullAbstract = () => {
            hideTimeout = window.setTimeout(() => {
                fullDescription.style.display = 'none';
                fullDescription.style.left = '0';
                fullDescription.style.right = 'auto';
            }, 300);
        };

        description.addEventListener('mouseenter', showFullAbstract);
        description.addEventListener('mouseleave', hideFullAbstract);
        fullDescription.addEventListener('mouseenter', () => clearTimeout(hideTimeout));
        fullDescription.addEventListener('mouseleave', hideFullAbstract);

        return cardContainer;
    }

    function filterAndRenderProjects() {
      let filteredProjects;
      if (activeTags.length === 0) {
        filteredProjects = allProjects;
      } else {
        filteredProjects = allProjects.filter(project =>
          project.tags && activeTags.every(tag => project.tags.includes(tag))
        );
      }
      renderProjects(filteredProjects);
    }
    
    // Event listeners for tag buttons
    tagButtons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedTag = button.getAttribute('data-tag');
        if (!selectedTag) return;
        
        button.classList.toggle('active');

        const index = activeTags.indexOf(selectedTag);
        if (index > -1) {
          activeTags.splice(index, 1);
        } else {
          activeTags.push(selectedTag);
        }
        
        if (activeTags.length > 0) {
          if (clearFilterButton) {
            clearFilterButton.classList.remove('opacity-0', 'pointer-events-none');
            clearFilterButton.setAttribute('aria-hidden', 'false');
          }
        } else {
          if (clearFilterButton) {
            clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
            clearFilterButton.setAttribute('aria-hidden', 'true');
          }
        }
        
        filterAndRenderProjects();
      });
    });
    
    // Clear filter handler
    if (clearFilterButton) {
      clearFilterButton.addEventListener('click', () => {
        activeTags = [];
        // Reset active tag styling
        tagButtons.forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Hide clear filter button without affecting layout height
        clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
        clearFilterButton.setAttribute('aria-hidden', 'true');
        
        // Show all projects
        renderProjects(allProjects);
      });
    }
  });
</script>