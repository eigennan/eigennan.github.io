---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectList from '../../components/ProjectList.astro';
import { projects } from './projects';

// Extract all unique tags from projects
const allTags = [...new Set(projects.flatMap(project => project.tags || []))].sort();
---

<BaseLayout title="Projects">
  <div class="container mx-auto px-4">
    <div class="space-y-6">
      <div class="border dark:border-zinc-800 rounded-xl p-4 shadow-sm bg-white/80 dark:bg-zinc-900/70">
        <div class="flex flex-col gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <h3 class="text-lg font-medium">Filter by tag</h3>
            <button
              id="clear-filter"
              class="tag-pill clear-pill items-center gap-1.5 justify-start ml-auto hover:-translate-y-0.5 opacity-0 pointer-events-none"
              aria-hidden="true"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
              Clear filter
            </button>
          </div>
          <div class="flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <button
                class="tag-filter tag-pill break-words"
                data-tag={tag}
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </div>
      <div id="project-container">
        <ProjectList projects={projects} />
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ projects }}>
  // Client-side filtering logic
  document.addEventListener('DOMContentLoaded', () => {
    const tagButtons = document.querySelectorAll('.tag-filter');
    const clearFilterButton = document.getElementById('clear-filter');
    const projectContainer = document.getElementById('project-container');

    // Ensure clear button is visually hidden on load without collapsing layout
    if (clearFilterButton) {
      clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
      clearFilterButton.setAttribute('aria-hidden', 'true');
    }
    
    // Use the server-side passed projects variable directly
    const allProjects = projects;
    
    // Helper function to render filtered projects
    function renderProjects(filtered) {
      if (!projectContainer) return;
      
      // Clear current projects
      projectContainer.innerHTML = '';
      
      if (filtered.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'text-center py-8 text-zinc-500';
        noResults.textContent = 'No projects match this filter';
        projectContainer.appendChild(noResults);
        return;
      }
      
      // Create new project list with filtered projects
      const projectList = document.createElement('div');
      projectList.className = 'grid grid-cols-1 md:grid-cols-2 gap-5';
      
      filtered.forEach((project, index) => {
        const projectCard = createProjectCard(project, index);
        projectList.appendChild(projectCard);
      });
      
      projectContainer.appendChild(projectList);

      // Re-render KaTeX expressions in the dynamically created content
      if (typeof renderMathInElement !== 'undefined') {
        // For KaTeX auto-render extension
        document.querySelectorAll('.description-text, .description-text-full').forEach(el => {
          renderMathInElement(el, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false}
            ],
            throwOnError: false
          });
        });
      } else if (window.katex) {
        // Direct KaTeX API
        document.querySelectorAll('.description-text, .description-text-full').forEach(el => {
          const mathElements = el.querySelectorAll('.math, .katex');
          mathElements.forEach(math => {
            const text = math.textContent || math.getAttribute('data-math');
            if (text) {
              try {
                katex.render(text, math);
              } catch (e) {
                console.error("KaTeX rendering error:", e);
              }
            }
          });
        });
      } else if (window.MathJax) {
        // For MathJax as fallback
        MathJax.typeset && MathJax.typeset();
      }
    }
    
    // Helper function to create a project card
    function createProjectCard(project, index) {
      const card = document.createElement('div');
      card.className = 'border dark:border-zinc-700 rounded-xl shadow-sm p-5 relative bg-white dark:bg-zinc-900/70 transition-all duration-[220ms] hover:-translate-y-1 hover:shadow-xl hover:border-zinc-400 dark:hover:border-zinc-500 h-full';

      const cardInner = document.createElement('div');
      cardInner.className = 'grid gap-6 h-full md:grid-cols-[160px,1fr] items-start';

      if (project.image) {
        const coverBox = document.createElement('div');
        coverBox.className = 'project-cover mx-auto md:mx-0 mb-4 md:mb-0 w-full md:w-40 shrink-0';
        const img = document.createElement('img');
        img.src = typeof project.image === 'string' ? project.image : project.image?.src || '';
        img.alt = project.imageAlt || project.name;
        img.loading = 'lazy';
        img.className = 'rounded w-full h-36 object-cover';
        coverBox.appendChild(img);
        cardInner.appendChild(coverBox);
      }
      
      // Project title
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'flex-1 flex flex-col min-h-[9rem] h-full';

      const title = document.createElement('h3');
      title.className = 'font-semibold mb-2';
      const titleLink = document.createElement('a');
      titleLink.className = 'hover:underline';
      titleLink.href = project.demoLink || '#';
      if (project.demoLink) {
        titleLink.target = '_blank';
        titleLink.rel = project.demoLinkRel || 'noopener';
      }
      titleLink.textContent = project.name;
      title.appendChild(titleLink);
      
      // Project description container
      const descContainer = document.createElement('div');
      descContainer.className = 'text-zinc-600 dark:text-zinc-300 mb-4 description-container text-sm flex-grow';
      
      // Short description with line clamp
      const descShort = document.createElement('p');
      descShort.className = 'description-text line-clamp-2 min-h-[60px] max-h-[60px]';
      descShort.id = `project-description-${index}`;
      descShort.textContent = project.description;
      
      // Full description (hidden initially)
      const descFull = document.createElement('p');
      descFull.className = 'description-text-full hidden';
      descFull.id = `project-description-full-${index}`;
      descFull.textContent = project.description;
      
      // Add descriptions to container
      descContainer.appendChild(descShort);
      descContainer.appendChild(descFull);
      
      // Add read more button if description is long enough
      if (project.description && project.description.length > 100) {
        const readMoreBtn = document.createElement('button');
        readMoreBtn.id = `project-read-more-${index}`;
        readMoreBtn.className = 'text-sm font-bold text-zinc-600 dark:text-zinc-300 hover:underline mt-1 project-read-more-btn';
        readMoreBtn.textContent = 'Read more';
        readMoreBtn.onclick = function() {
          toggleProjectDescription(index);
        };
        descContainer.appendChild(readMoreBtn);
      }
      
      // Links section
      const linksDiv = document.createElement('div');
      linksDiv.className = 'flex justify-end gap-3 mt-auto self-end';
      
      // Add article link if exists
      if (project.postLink) {
        const articleLink = document.createElement('a');
        articleLink.className = 'tag-pill flex items-center gap-1';
        articleLink.href = project.postLink;
        articleLink.textContent = 'Article';
        linksDiv.appendChild(articleLink);
      }
      
      // Add demo link if exists
      if (project.demoLink) {
        const demoLink = document.createElement('a');
        demoLink.className = 'tag-pill flex items-center gap-1';
        demoLink.href = project.demoLink;
        demoLink.target = '_blank';
        demoLink.rel = project.demoLinkRel || 'noopener';
        demoLink.textContent = 'Demo';
        linksDiv.appendChild(demoLink);
      }

      // Add paper link if exists
      if (project.paperLink) {
        const paperLink = document.createElement('a');
        paperLink.className = 'tag-pill flex items-center gap-1';
        paperLink.href = project.paperLink;
        paperLink.target = '_blank';
        paperLink.rel = 'noopener';
        paperLink.textContent = 'Paper';
        linksDiv.appendChild(paperLink);
      }
      
      // Assemble card
      contentWrapper.appendChild(title);
      contentWrapper.appendChild(descContainer);
      contentWrapper.appendChild(linksDiv);

      cardInner.appendChild(contentWrapper);
      card.appendChild(cardInner);
      
      return card;
    }
    
    // Copy the toggleDescription function from ProjectList.astro
    function toggleProjectDescription(index) {
      const descriptionEl = document.getElementById(`project-description-${index}`);
      const descriptionFullEl = document.getElementById(`project-description-full-${index}`);
      const buttonEl = document.getElementById(`project-read-more-${index}`);
      
      if (!descriptionEl || !descriptionFullEl || !buttonEl) return;
      
      if (descriptionEl.classList.contains('line-clamp-2')) {
        // Expand
        descriptionEl.classList.remove('line-clamp-2');
        descriptionEl.classList.add('hidden');
        descriptionFullEl.classList.remove('hidden');
        buttonEl.textContent = 'Show less';
      } else {
        // Collapse
        descriptionEl.classList.add('line-clamp-2');
        descriptionEl.classList.remove('hidden');
        descriptionFullEl.classList.add('hidden');
        buttonEl.textContent = 'Read more';
      }
    }
    
    // Add click handlers to tag buttons
    tagButtons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedTag = button.getAttribute('data-tag');
        if (!selectedTag) return;
        
        // Update active tag styling
        tagButtons.forEach(btn => {
          btn.classList.remove('filter-active');
        });
        button.classList.add('filter-active');
        
        // Show clear filter button
        if (clearFilterButton) {
          clearFilterButton.classList.remove('opacity-0', 'pointer-events-none');
          clearFilterButton.setAttribute('aria-hidden', 'false');
        }
        
        // Filter projects
        const filteredProjects = allProjects.filter(project => 
          project.tags && project.tags.includes(selectedTag)
        );
        
        renderProjects(filteredProjects);
      });
    });
    
    // Clear filter handler
    if (clearFilterButton) {
      clearFilterButton.addEventListener('click', () => {
        // Reset active tag styling
        tagButtons.forEach(btn => {
          btn.classList.remove('filter-active');
        });
        
        // Hide clear filter button without affecting layout height
        clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
        clearFilterButton.setAttribute('aria-hidden', 'true');
        
        // Show all projects
        renderProjects(allProjects);
      });
    }
  });
</script>