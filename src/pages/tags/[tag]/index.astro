---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import BaseLayout from '@src/layouts/BaseLayout.astro';
import { slugify, unslugify } from '@src/utils';
import PostsByYear from '@src/components/PostsByYear.astro';

type BlogPost = CollectionEntry<'blog'>;
export const getStaticPaths = async () => {
	const allPosts: BlogPost[] = (await getCollection('blog')).filter((post) => post.data.draft !== true);
	return [
		...new Set(
			allPosts
				.map((post) => post.data.tags)
				.flat()
				.filter((tag) => !!tag)
		)
	].map((tag) => ({ params: { tag: slugify(tag || '') } }));
};

const { tag } = Astro.params;
const allPosts: BlogPost[] = (await getCollection('blog'))
	.filter((post) => post.data.draft !== true)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const taggedPosts = allPosts.filter((post) => post.data.tags?.map((tag) => slugify(tag)).includes(tag || ''));
const title = `All Posts Tagged with ${unslugify(tag || '')}`;
const description = `All Posts Tagged with ${unslugify(tag || '')}`;
---

<BaseLayout
	title={title}
	description={description}
>
  <div class='container'>
		<div class="mb-10 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
			<h1 class="text-3xl font-bold mb-0">{title}</h1>
			<a
				href="/blog/"
				class="tag-pill clear-pill inline-flex items-center gap-1.5 hover:-translate-y-0.5 transition-all"
				aria-label="Clear filters and show all posts"
			>
				<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M18 6 6 18"></path>
					<path d="m6 6 12 12"></path>
				</svg>
				Clear filter
			</a>
	    </div>
    <PostsByYear posts={taggedPosts}/>
  </div>
</BaseLayout>
