---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PublicationList from '../../components/PublicationList.astro';
import { publications } from './publications';

// Extract all unique tags from publications
const allTags = [...new Set(publications.flatMap(publication => publication.tags || []))].sort();
---

<BaseLayout
	title="All Publications"
	description="All my project portfolio from real projects to open source projects."
>
  <div class='container'>
    <div class="space-y-6">
      <div class="glass-panel p-4">
        <div class="flex flex-col gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <h3 class="text-lg font-medium">Filter by tag</h3>
            <button
              id="clear-filter"
              class="tag-pill clear-pill items-center gap-1.5 justify-start ml-auto opacity-0 pointer-events-none"
              aria-hidden="true"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
              Clear filter
            </button>
          </div>
          <div class="flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <button
                class="tag-filter tag-pill break-words"
                data-tag={tag}
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </div>
      <div id="publication-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <PublicationList publications={publications} />
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ publications }}>
  document.addEventListener('DOMContentLoaded', () => {
    const tagButtons = document.querySelectorAll('.tag-filter');
    const clearFilterButton = document.getElementById('clear-filter');
    const publicationContainer = document.getElementById('publication-container');
    let activeTags = [];

    if (clearFilterButton) {
      clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
      clearFilterButton.setAttribute('aria-hidden', 'true');
    }

    const allPublications = publications;

    function renderPublications(filtered) {
      if (!publicationContainer) return;
      publicationContainer.innerHTML = '';

      if (filtered.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'text-center py-8 text-zinc-500 col-span-full';
        noResults.textContent = 'No publications match this filter';
        publicationContainer.appendChild(noResults);
        return;
      }

      filtered.forEach(publication => {
        const publicationCard = createPublicationCard(publication);
        publicationContainer.appendChild(publicationCard);
      });
    }

    function createPublicationCard(publication) {
        const cardContainer = document.createElement('div');
        cardContainer.className = 'h-full';

        const card = document.createElement('div');
        card.className = 'group flex flex-col h-full overflow-hidden rounded-xl glass-panel hover:scale-[1.015] transition-all duration-300';

        const imageContainer = document.createElement('div');
        imageContainer.className = 'aspect-video w-full overflow-hidden bg-zinc-100 dark:bg-zinc-800 relative';
        if (publication.coverImage) {
            const img = document.createElement('img');
            img.src = publication.coverImage;
            img.alt = publication.name;
            img.className = 'h-full w-full object-cover object-center transition-transform duration-300 group-hover:scale-105';
            img.width = 720;
            img.height = 360;
            imageContainer.appendChild(img);
        } else {
            const noImage = document.createElement('div');
            noImage.className = 'flex h-full items-center justify-center text-zinc-400 dark:text-zinc-600';
            noImage.innerHTML = `<span class="text-sm">No Image</span>`;
            imageContainer.appendChild(noImage);
        }

        const content = document.createElement('div');
        content.className = 'flex flex-1 flex-col p-5';

        const meta = document.createElement('div');
        meta.className = 'mb-2 text-sm text-zinc-500 dark:text-zinc-400';
        meta.textContent = `${publication.journal} - ${publication.year}`;

        const title = document.createElement('h3');
        title.className = 'mb-2 text-xl font-bold leading-tight text-zinc-900 dark:text-zinc-100 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors';
        const titleLink = document.createElement('a');
        titleLink.href = publication.paperLink;
        titleLink.target = '_blank';
        titleLink.rel = publication.paperLinkRel;
        titleLink.textContent = publication.name;
        title.appendChild(titleLink);

        const abstract = document.createElement('p');
        abstract.className = 'mb-4 flex-1 text-sm leading-relaxed text-zinc-600 dark:text-zinc-400 line-clamp-3';
        abstract.textContent = publication.abstract;

        const footer = document.createElement('div');
        footer.className = 'flex justify-end gap-3 mt-auto self-end';

        const details = document.createElement('details');
        details.className = 'relative';
        const summary = document.createElement('summary');
        summary.className = 'tag-pill cursor-pointer';
        summary.textContent = 'Cite';
        const pre = document.createElement('pre');
        pre.className = 'absolute bottom-full right-0 mb-2 p-2 bg-gray-100 dark:bg-zinc-800 rounded text-xs overflow-x-auto w-64 max-h-48 z-10';
        pre.style.whiteSpace = 'pre-wrap';
        pre.style.wordBreak = 'break-all';
        pre.textContent = publication.bibtex;
        details.appendChild(summary);
        details.appendChild(pre);
        footer.appendChild(details);

        if (publication.pdf) {
            const pdfLink = document.createElement('a');
            pdfLink.className = 'tag-pill';
            pdfLink.href = publication.pdf;
            pdfLink.target = '_blank';
            pdfLink.rel = publication.paperLinkRel;
            pdfLink.textContent = 'PDF';
            footer.appendChild(pdfLink);
        }

        if (publication.paperLink) {
            const paperLink = document.createElement('a');
            paperLink.className = 'tag-pill';
            paperLink.href = publication.paperLink;
            paperLink.target = '_blank';
            paperLink.rel = publication.paperLinkRel;
            paperLink.textContent = 'Paper';
            footer.appendChild(paperLink);
        }

        content.appendChild(meta);
        content.appendChild(title);
        content.appendChild(abstract);
        content.appendChild(footer);
        card.appendChild(imageContainer);
        card.appendChild(content);
        cardContainer.appendChild(card);
        return cardContainer;
    }

    function filterAndRenderPublications() {
      let filteredPublications;
      if (activeTags.length === 0) {
        filteredPublications = allPublications;
      } else {
        filteredPublications = allPublications.filter(p => 
          p.tags && activeTags.every(tag => p.tags.includes(tag))
        );
      }
      renderPublications(filteredPublications);
    }

    tagButtons.forEach(button => {
        button.addEventListener('click', () => {
            const selectedTag = button.getAttribute('data-tag');
            if (!selectedTag) return;

            button.classList.toggle('active');

            const index = activeTags.indexOf(selectedTag);
            if (index > -1) {
                activeTags.splice(index, 1);
            } else {
                activeTags.push(selectedTag);
            }

            if (activeTags.length > 0) {
                if (clearFilterButton) {
                    clearFilterButton.classList.remove('opacity-0', 'pointer-events-none');
                    clearFilterButton.setAttribute('aria-hidden', 'false');
                }
            } else {
                if (clearFilterButton) {
                    clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
                    clearFilterButton.setAttribute('aria-hidden', 'true');
                }
            }
            
            filterAndRenderPublications();
        });
    });

    if (clearFilterButton) {
        clearFilterButton.addEventListener('click', () => {
            activeTags = [];
            tagButtons.forEach(btn => btn.classList.remove('active'));
            clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
            clearFilterButton.setAttribute('aria-hidden', 'true');
            renderPublications(allPublications);
        });
    }
  });
</script>
