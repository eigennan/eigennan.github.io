---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostsByYear from '../../components/PostsByYear.astro';

type BlogPost = CollectionEntry<'blog'>;
const title = 'All Posts'
const description = 'Articles, guides, tutorials about front-end development.'

const posts = (await getCollection('blog')).sort((a: BlogPost, b: BlogPost) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const allTags = [...new Set(posts.flatMap((post) => post.data.tags || []))].sort();
---

<BaseLayout
	title={title}
	description={description}
>
  <div class='container'>
    <div class="space-y-6">
      <div class="border dark:border-zinc-800 rounded-xl p-4 shadow-sm bg-white/80 dark:bg-zinc-900/70">
        <div class="flex flex-col gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <h3 class="text-lg font-medium">Filter by tag</h3>
            <button id="blog-clear-filter" class="tag-pill items-center gap-1.5 justify-start ml-auto opacity-0 pointer-events-none" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
              Clear filter
            </button>
          </div>
          <div class="flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <button
                class="blog-tag-filter tag-pill break-words"
                data-tag={tag}
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </div>

      <div id="blog-post-container">
        <PostsByYear posts={posts}/>
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const tagButtons = document.querySelectorAll('.blog-tag-filter');
    const clearFilterButton = document.getElementById('blog-clear-filter');
    const postContainer = document.getElementById('blog-post-container');
    const postEntries = Array.from(document.querySelectorAll('.post-entry'));
    const yearGroups = Array.from(document.querySelectorAll('.year-group'));
    const noResultsId = 'blog-no-results';

    const hideClear = () => {
      if (!clearFilterButton) return;
      clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
      clearFilterButton.setAttribute('aria-hidden', 'true');
    };

    const showClear = () => {
      if (!clearFilterButton) return;
      clearFilterButton.classList.remove('opacity-0', 'pointer-events-none');
      clearFilterButton.setAttribute('aria-hidden', 'false');
    };

    const updateYearVisibility = () => {
      yearGroups.forEach((group) => {
        const visible = Array.from(group.querySelectorAll('.post-entry')).some((entry) => !entry.classList.contains('hidden'));
        group.classList.toggle('hidden', !visible);
      });
    };

    const removeNoResults = () => {
      const existing = document.getElementById(noResultsId);
      if (existing) existing.remove();
    };

    const showNoResults = () => {
      if (!postContainer) return;
      if (document.getElementById(noResultsId)) return;
      const msg = document.createElement('div');
      msg.id = noResultsId;
      msg.className = 'text-center py-8 text-zinc-500';
      msg.textContent = 'No posts match this filter';
      postContainer.appendChild(msg);
    };

    const applyFilter = (tag) => {
      const target = tag.toLowerCase();
      let anyVisible = false;

      postEntries.forEach((entry) => {
        const tags = (entry.dataset.tags || '').split('|||').filter(Boolean);
        const match = tags.includes(target);
        entry.classList.toggle('hidden', !match);
        if (match) anyVisible = true;
      });

      updateYearVisibility();
      removeNoResults();
      if (!anyVisible) showNoResults();
    };

    const clearFilter = () => {
      postEntries.forEach((entry) => entry.classList.remove('hidden'));
      yearGroups.forEach((group) => group.classList.remove('hidden'));
      removeNoResults();
    };

    // Initialize hidden state
    hideClear();
    removeNoResults();

    tagButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const selectedTag = button.getAttribute('data-tag');
        if (!selectedTag) return;

        tagButtons.forEach((btn) => {
          btn.classList.remove('filter-active');
        });
        button.classList.add('filter-active');

        showClear();
        applyFilter(selectedTag);
      });
    });

    if (clearFilterButton) {
      clearFilterButton.addEventListener('click', () => {
        tagButtons.forEach((btn) => {
          btn.classList.remove('filter-active');
        });

        hideClear();
        clearFilter();
      });
    }
  });
</script>
