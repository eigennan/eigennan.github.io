---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';

type BlogPost = CollectionEntry<'blog'>;
const title = 'All Posts'
const description = 'Articles, guides, tutorials about front-end development.'

const posts = (await getCollection('blog'))
  .filter((post) => post.data.draft !== true)
  .sort((a: BlogPost, b: BlogPost) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const allTags = [...new Set(posts.flatMap((post) => post.data.tags || []))].sort();
---

<BaseLayout
	title={title}
	description={description}
>
  <div class='container'>
    <div class="space-y-6">
      <div class="glass-panel p-4">
        <div class="flex flex-col gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <h3 class="text-lg font-medium">Filter by tag</h3>
            <button
              id="blog-clear-filter"
              class="tag-pill clear-pill items-center gap-1.5 justify-start ml-auto opacity-0 pointer-events-none"
              aria-hidden="true"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
              Clear filter
            </button>
          </div>
          <div class="flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <button
                class="blog-tag-filter tag-pill break-words"
                data-tag={tag}
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </div>

      <div id="blog-post-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {posts.map((post) => (
          <div class="post-entry h-full" data-tags={(post.data.tags || []).map((tag) => tag.toLowerCase()).join('|||')}>
            <BlogCard post={post} />
          </div>
        ))}
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const tagButtons = document.querySelectorAll('.blog-tag-filter');
    const clearFilterButton = document.getElementById('blog-clear-filter');
    const postContainer = document.getElementById('blog-post-container');
    const postEntries = Array.from(document.querySelectorAll('.post-entry'));
    const noResultsId = 'blog-no-results';
    let activeTags = [];

    const hideClear = () => {
      if (!clearFilterButton) return;
      clearFilterButton.classList.add('opacity-0', 'pointer-events-none');
      clearFilterButton.setAttribute('aria-hidden', 'true');
    };

    const showClear = () => {
      if (!clearFilterButton) return;
      clearFilterButton.classList.remove('opacity-0', 'pointer-events-none');
      clearFilterButton.setAttribute('aria-hidden', 'false');
    };

    const removeNoResults = () => {
      const existing = document.getElementById(noResultsId);
      if (existing) existing.remove();
    };

    const showNoResults = () => {
      if (!postContainer) return;
      if (document.getElementById(noResultsId)) return;
      const msg = document.createElement('div');
      msg.id = noResultsId;
      msg.className = 'col-span-full text-center py-8 text-zinc-500';
      msg.textContent = 'No posts match this filter';
      postContainer.appendChild(msg);
    };

    const filterPosts = () => {
      let hasResults = false;
      postEntries.forEach((entry) => {
        const entryTags = entry.dataset.tags ? entry.dataset.tags.split('|||') : [];
        const matches = activeTags.length === 0 || activeTags.every(activeTag => entryTags.includes(activeTag.toLowerCase()));
        entry.classList.toggle('hidden', !matches);
        if (matches) hasResults = true;
      });

      if (hasResults) {
        removeNoResults();
      } else if (activeTags.length > 0) {
        showNoResults();
      }
    };

    tagButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const tag = btn.getAttribute('data-tag');
        if (!tag) return;

        btn.classList.toggle('active');
        
        if (btn.classList.contains('active')) {
          activeTags.push(tag);
        } else {
          activeTags = activeTags.filter(t => t !== tag);
        }

        if (activeTags.length > 0) {
            showClear();
        } else {
            hideClear();
        }
        
        filterPosts();
      });
    });

    clearFilterButton?.addEventListener('click', () => {
      activeTags = [];
      tagButtons.forEach((b) => b.classList.remove('active'));
      hideClear();
      filterPosts();
      removeNoResults();
    });
  });
</script>
